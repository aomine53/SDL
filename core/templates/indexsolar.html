{% extends "layouts/base.html" %}

{% block title %} Dashboard {% endblock title %}

<!-- Specific CSS goes HERE  -->
{% block stylesheets %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Add icon library -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
          integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/resources/demos/style.css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.1.2/css/tempusdominus-bootstrap-4.min.css"
          integrity="sha512-PMjWzHVtwxdq7m7GIxBot5vdxUY+5aKP9wpKtvnNBZrVv1srI8tU6xvFMzG8crLNcMj/8Xl/WWmo/oAP/40p1g=="
          crossorigin="anonymous"/>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <link rel="stylesheet" href="/static/assets/weather-icons-master/css/weather-icons.min.css">
    <link rel="stylesheet"
          href="/static/assets/jQuery-Multiple-Select-Plugin-For-Bootstrap-Bootstrap-Multiselect/dist/css/bootstrap-multiselect.min.css">
    <style>
        .btn:hover {
            background-color: RoyalBlue;
        }
    </style>
    <style>

        #mymapid {
            z-index: 0;
        }
    </style>
{% endblock stylesheets %}

{% block content %}
    <div class="row gap-20 masonry pos-r">
        <div class="masonry-item col-md-12">
            <div class="bd p-10" style="background-color: #313131;">
                <div class="layers" style="align-items: start;">
                    <small style="color: #EC4a49">Inverter 6 Tripped</small>
                    <small style="color: #eed202">Inverter 2 Temp High</small>
                    <small style="color: #eed202">Batt SOC Low</small>
                    <small style="color: #EC4a49">DG Fuel Low</small>
                    <small style="color: #eed202">PR Low</small>
                </div>
            </div>
        </div>
        <div class="masonry-sizer col-md-6"></div>
        <div class="masonry-item w-100">
            <div class="row gap-20">
                <!-- #Toatl Visits ==================== -->
                <div class="col-md-2">
                    <div class="layers bd p-20" style="background-color: #313131;">
                        <div class="layer w-100 mB-10">
                            <h6 class="lh-1" style="color: white;">Consumption</h6>
                        </div>
                        <div class="layer w-100">
                            <div class="peers ai-sb fxw-nw">
                                <div class="peer peer-greed">
                                    <span id="sparklinedash"></span>
                                </div>
                                <div class="peer">
                                    <span id="rno"
                                          class="d-ib lh-0 va-m fw-600 bdrs-10em pX-15 pY-15 bgc-green-50 c-green-500">00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- #Total Page Views ==================== -->
                <div class="col-md-2">
                    <div class="layers bd p-20" style="background-color: #313131;">
                        <div class="layer w-100 mB-10">
                            <h6 class="lh-1">Solar Generation</h6>
                        </div>
                        <div class="layer w-100">
                            <div class="peers ai-sb fxw-nw">
                                <div class="peer peer-greed">
                                    <span id="sparklinedash2"></span>
                                </div>
                                <div class="peer">
                                    <span id="vbat"
                                          class="d-ib lh-0 va-m fw-600 bdrs-10em pX-15 pY-15 bgc-red-50 c-red-500">-7%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- #Unique Visitors ==================== -->
                <div class="col-md-2">
                    <div class="layers bd p-20" style="background-color: #313131;">
                        <div class="layer w-100 mB-10">
                            <h6 class="lh-1">Export to grid</h6>
                        </div>
                        <div class="layer w-100">
                            <div class="peers ai-sb fxw-nw">
                                <div class="peer peer-greed">
                                    <span id="sparklinedash3"></span>
                                </div>
                                <div class="peer">
                                    <span id="vin"
                                          class="d-ib lh-0 va-m fw-600 bdrs-10em pX-15 pY-15 bgc-purple-50 c-purple-500">~12%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- #Bounce Rate ==================== -->
                <div class="col-md-2">
                    <div class="layers bd p-20" style="background-color: #313131;">
                        <div class="layer w-100 mB-10">
                            <h6 class="lh-1">Import From Grid</h6>
                        </div>
                        <div class="layer w-100">
                            <div class="peers ai-sb fxw-nw">
                                <div class="peer peer-greed">
                                    <span id="sparklinedash4"></span>
                                </div>
                                <div class="peer">
                                    <span id="spdk"
                                          class="d-ib lh-0 va-m fw-600 bdrs-10em pX-15 pY-15 bgc-blue-50 c-blue-500">33%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="layers bd p-20" style="background-color: #313131;">
                        <div class="layer w-100 mB-10">
                            <h6 class="lh-1">Battery</h6>
                        </div>
                        <div class="layer w-100">
                            <div class="peers ai-sb fxw-nw">
                                <div class="peer peer-greed">
                                    <span id="sparklinedash4"></span>
                                </div>
                                <div class="peer">
                                    <strong>±</strong>
                                    <span id="spdk"
                                          class="d-ib lh-0 va-m fw-600 bdrs-10em pX-15 pY-15 bgc-blue-50 c-blue-500">33</span>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="col-md-2">
                    <div class="layers bd p-20" style="background-color: #313131;">
                        <div class="layer w-100 mB-10">
                            <h6 class="lh-1">Import From DG</h6>
                        </div>
                        <div class="layer w-100">
                            <div class="peers ai-sb fxw-nw">
                                <div class="peer peer-greed">
                                    <span id="sparklinedash4"></span>
                                </div>
                                <div class="peer">
                                    <span id="spdk"
                                          class="d-ib lh-0 va-m fw-600 bdrs-10em pX-15 pY-15 bgc-blue-50 c-blue-500">33%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="masonry-item col-12">
            <!-- #Site Visits ==================== -->
            <div class="bd" style="background-color: #313131;">
                <div class="peers fxw-nw@lg+ ai-s">
                    <div class="peer peer-greed w-70p@lg+ w-100@lg- p-20">
                        <div class="layers">
                            <div class="layer w-100">
                                <div id="mymapid" style="
                                     height:500px ;
                                     position: sticky;
                                     overflow: hidden;
                                     background-color: transparent;
                                ">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="peer bdL p-20 w-30p@lg+ w-100p@lg-">
                        <!-- #Weather ==================== -->
                        <div class="bd" style="background-color: #313131;">
                            <div class="layers">
                                <!-- Widget Title -->


                                <!-- Today Weather -->
                                <div class="layer w-100">
                                    <div class="peers ai-c jc-sb fxw-nw">
                                        <div class="peer peer-greed">
                                            <div class="layers">
                                                <!-- Temprature -->
                                                <div class="layer w-100">
                                                    <div class="peers fxw-nw ai-c">
                                                        <div class="peer mR-20">
                                                            <h3 id="todaytemp">32<sup>°F</sup></h3>
                                                        </div>
                                                        <div class="peer">
                                                            {#                                                              <img src="http://openweathermap.org/img/wn/02n@2x.png" alt="" width="44" height="44">#}
                                                            <i id="todayweather" class="wi wi-day-sunny"
                                                               style="color: #ffc107; font-size: 40px"></i>
                                                            {#                                                            <canvas id="todayweather" class="wi wi-night-sleet" width="44" height="44"></canvas>#}
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Condition -->
                                                <div class="layer w-100">
                                                    <span id="todayweatherdesc" class="fw-600">Partly Clouds</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="peer">
                                            <div class="layers ai-fe">
                                                <div class="layer">
                                                    <h5 id="todaysday" class="mB-5">Monday</h5>
                                                </div>
                                                <div class="layer">
                                                    <span id="todaysdate" class="fw-600">Nov, 01 2017</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Today Weather Extended -->
                                <div class="layer w-100 mY-30">
                                    <div class="layers bdB">
                                        <div class="layer w-100 bdT pY-5">
                                            <div class="peers ai-c jc-sb fxw-nw">
                                                <div class="peer">
                                                    <span>Sunrise</span>
                                                </div>
                                                <div class="peer ta-r">
                                                    <span id="todayssunrise" class="fw-600">05:00 AM</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layer w-100 bdT pY-5">
                                            <div class="peers ai-c jc-sb fxw-nw">
                                                <div class="peer">
                                                    <span>Sunset</span>
                                                </div>
                                                <div class="peer ta-r">
                                                    <span id="todayssunset" class="fw-600">06:00 PM</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layer w-100 bdT pY-5">
                                            <div class="peers ai-c jc-sb fxw-nw">
                                                <div class="peer">
                                                    <span>Irradiance</span>
                                                </div>
                                                <div class="peer ta-r">
                                                    <span class="fw-600">10 Wb/m<sup>2</sup></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layer w-100 bdT pY-5">
                                            <div class="peers ai-c jc-sb fxw-nw">
                                                <div class="peer">
                                                    <span>Ambient Temperature</span>
                                                </div>
                                                <div class="peer ta-r">
                                                    <span class="fw-600">10 ℃</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layer w-100 bdT pY-5">
                                            <div class="peers ai-c jc-sb fxw-nw">
                                                <div class="peer">
                                                    <span>Module Temperature</span>
                                                </div>
                                                <div class="peer ta-r">
                                                    <span class="fw-600">10 ℃</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layer w-100 bdT pY-5">
                                            <div class="peers ai-c jc-sb fxw-nw">
                                                <div class="peer">
                                                    <span>Wind Speed</span>
                                                </div>
                                                <div class="peer ta-r">
                                                    <span id="todayswindspeed" class="fw-600">10km/h</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layer w-100 bdT pY-5">
                                            <div class="peers ai-c jc-sb fxw-nw">
                                                <div class="peer">
                                                    <span>Wind Direction</span>
                                                </div>
                                                <div class="peer ta-r">
                                                    <span id="todayswinddir" class="fw-600">10°</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="layer w-100 bdT pY-5">
                                            <div class="peers ai-c jc-sb fxw-nw">
                                                <div class="peer">
                                                    <span>Humidity</span>
                                                </div>
                                                <div class="peer ta-r">
                                                    <span id="todayshumdity" class="fw-600">10%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Week Forecast -->
                                <div class="layer w-100">
                                    <div class="peers peers-greed ai-fs ta-c">
                                        <div class="peer">
                                            <h6 class="mB-10">MON</h6>
                                            {#                                            <img src="http://openweathermap.org/img/wn/10d@2x.png" alt="" width="30" height="30">#}
                                            <i id="monweather" class="wi wi-day-sunny" style="color: #ffc107"></i>
                                            {#                                            <canvas id="slid" class="partly-cloudy-night" width="30" height="30"></canvas>#}
                                            <small><span id="mtemp" class="d-b fw-600">32<sup>°F</sup></span></small>
                                        </div>
                                        <div class="peer">
                                            <h6 class="mB-10">TUE</h6>
                                            <i id="tueweather" class="wi wi-day-sunny" style="color: #ffc107"></i>
                                            {#                                            <canvas class="clear-day" width="30" height="30"></canvas>#}
                                            <small><span id="tutemp" class="d-b fw-600">30<sup>°F</sup></span></small>
                                        </div>
                                        <div class="peer">
                                            <h6 class="mB-10">WED</h6>
                                            <i id="wedweather" class="wi wi-day-sunny" style="color: #ffc107"></i>
                                            {#                                            <canvas class="partly-cloudy-day" width="30" height="30"></canvas>#}
                                            <small><span id="wtemp" class="d-b fw-600">28<sup>°F</sup></span></small>
                                        </div>
                                        <div class="peer">
                                            <h6 class="mB-10">THR</h6>
                                            <i id="thrweather" class="wi wi-day-sunny" style="color: #ffc107"></i>
                                            {#                                            <canvas class="cloudy" width="30" height="30"></canvas>#}
                                            <small><span id="thtemp" class="d-b fw-600">32<sup>°F</sup></span></small>
                                        </div>
                                        <div class="peer">
                                            <h6 class="mB-10">FRI</h6>
                                            <i id="friweather" class="wi wi-day-sunny" style="color: #ffc107"></i>
                                            {#                                            <canvas class="snow" width="30" height="30"></canvas>#}
                                            <small><span id="ftemp" class="d-b fw-600">24<sup>°F</sup></span></small>
                                        </div>
                                        <div class="peer">
                                            <h6 class="mB-10">SAT</h6>
                                            <i id="satweather" class="wi wi-day-sunny" style="color: #ffc107"></i>
                                            {#                                            <canvas class="wind" width="30" height="30"></canvas>#}
                                            <small><span id="satemp" class="d-b fw-600">28<sup>°F</sup></span></small>
                                        </div>
                                        <div class="peer">
                                            <h6 class="mB-10">SUN</h6>
                                            <i id="sunweather" class="wi wi-day-sunny" style="color: #ffc107"></i>
                                            {#                                            <canvas class="sleet" width="30" height="30"></canvas>#}
                                            <small><span id="sutemp" class="d-b fw-600">32<sup>°F</sup></span></small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="peer bdL p-20 w-30p@lg+ w-100p@lg-">
                        <div class="layers">
                            <div class="layer w-100">
                                <!-- Progress Bars -->
                                <div class="layers">
                                    <div class="layer w-100 mT-15">
                                        <small class="fw-600 c-white-700">Battery SOC</small>
                                        <span class="pull-right c-grey-600 fsz-sm">90%</span>
                                        <div class="progress mT-10">
                                            <div class="progress-bar bgc-blue-grey-500" role="progressbar"
                                                 aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"
                                                 style="width:90%;"><span class="sr-only">90% Complete</span></div>
                                        </div>
                                    </div>
                                    <div class="layer w-100 mT-15">
                                        <small class="fw-600 c-white-700">Consumption Till Date(Mwh)</small>
                                        <span class="pull-right c-grey-600 fsz-sm">50%</span>
                                        <div class="progress mT-10">
                                            <div class="progress-bar bgc-deep-purple-500" role="progressbar"
                                                 aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"
                                                 style="width:50%;"><span class="sr-only">50% Complete</span></div>
                                        </div>
                                    </div>
                                    <div class="layer w-100 mT-15">
                                        <small class="fw-600 c-white-700">Solar Generation Till Date(Mwh)</small>
                                        <span class="pull-right c-grey-600 fsz-sm">80%</span>
                                        <div class="progress mT-10">
                                            <div class="progress-bar bgc-green-500" role="progressbar"
                                                 aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"
                                                 style="width:80%;"><span class="sr-only">80% Complete</span></div>
                                        </div>
                                    </div>
                                    <div class="layer w-100 mT-15">
                                        <small class="fw-600 c-white-700">Export To Grid Till Date(Mwh)</small>
                                        <span class="pull-right c-grey-600 fsz-sm">40%</span>
                                        <div class="progress mT-10">
                                            <div class="progress-bar bgc-light-blue-500" role="progressbar"
                                                 aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"
                                                 style="width:40%;"><span class="sr-only">40% Complete</span></div>
                                        </div>
                                    </div>
                                    <div class="layer w-100 mT-15">
                                        <small class="fw-600 c-white-700">Import From Grid Till Date(Mwh)</small>
                                        <span class="pull-right c-grey-600 fsz-sm">90%</span>
                                        <div class="progress mT-10">
                                            <div class="progress-bar bgc-blue-grey-500" role="progressbar"
                                                 aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"
                                                 style="width:90%;"><span class="sr-only">90% Complete</span></div>
                                        </div>
                                    </div>
                                    <div class="layer w-100 mT-15">
                                        <small class="fw-600 c-white-700">Import From DG Till Date(Mwh)</small>
                                        <span class="pull-right c-grey-600 fsz-sm">90%</span>
                                        <div class="progress mT-10">
                                            <div class="progress-bar bgc-blue-grey-500" role="progressbar"
                                                 aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"
                                                 style="width:90%;"><span class="sr-only">90% Complete</span></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Pie Charts -->
                                <div class="peers pT-20 mT-20 bdT fxw-nw@lg+ jc-sb ta-c gap-10">
                                    <div class="peer">
                                        <div class="easy-pie-chart" data-size="80" data-percent="75"
                                             data-bar-color="#f44336">
                                            <span></span>
                                        </div>
                                        <small class="fw-600 c-grey-700">Today PR</small>
                                    </div>
                                    <div class="peer">
                                        <div class="easy-pie-chart" data-size="80" data-percent="50"
                                             data-bar-color="#2196f3">
                                            <span></span>
                                        </div>
                                        <small class="fw-600 c-grey-700">Monthly PR</small>
                                    </div>
                                    <div class="peer">
                                        <div class="easy-pie-chart" data-size="80" data-percent="90"
                                             data-bar-color="#ff9800">
                                            <span></span>
                                        </div>
                                        <small class="fw-600 c-grey-700">Till Date PR</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="masonry-item col-md-12">
            <div class="p-20 bd" style="background-color: #313131;">
                <div class="col mb-20">
                    <div class="row justify-content-center" style="background-color: #313131;">
                        <div class="col-lg-9">
                            <div class="row">
                                <div class="col-md-5">
                                    <div class=" input-group date" id="datetimepicker1" data-target-input="nearest">
                                        <input type="text" id="fromdata" class="form-control datetimepicker-input"
                                               data-target="#datetimepicker1">
                                        <div class="input-group-append" data-target="#datetimepicker1"
                                             data-toggle="datetimepicker">
                                            <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <div class="input-group date" id="datetimepicker2" data-target-input="nearest">
                                        <input type="text" id="todata" class="form-control datetimepicker-input"
                                               data-target="#datetimepicker2">
                                        <div class="input-group-append" data-target="#datetimepicker2"
                                             data-toggle="datetimepicker">
                                            <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-primary mb-1 mr-2"
                                            onclick="get_archive_data()"><i
                                            class="fa fa-search"></i></button>
                                    <button type="button" class="btn btn-primary mb-1 " onclick="refreshdata()"><i
                                            class="fa fa-refresh"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="selectelements" class="row justify-content-around">
                        <select id="selectplant" name="Select Plant" class="custom-select col-md-3 col-lg-2 "
                                style="margin-top: 10px; text-align-last: center ">
                            <option value="none" selected disabled hidden>
                                Select Plant
                            </option>
                            {% for i in device %}
                                <option value="{{ i.device_id }}">{{ i.device_id }}</option>
                            {% endfor %}
                        </select>
                        <select id="selectdevice" name="Select Device" class="custom-select col-md-3 col-lg-2"
                                style="margin-top: 10px; text-align-last: center">
                            <option value="none" selected disabled hidden>
                                Select Device
                            </option>
                            {% for i in device %}
                                <option value="{{ i.device_id }}">{{ i.device_id }}</option>
                            {% endfor %}
                        </select>
                        <div class="col-md-3 col-lg-2" style="margin-top: 10px;">
                            <select id="myFilter" multiple="multiple">
                                <option value="none" selected disabled hidden>
                                    Select Parameters
                                </option>
                            </select>
                        </div>
                        <div class="col-md-3 col-lg-2" style="margin-top: 10px;">
                            <select id="myFilter2" multiple="multiple"
                                    style="margin-top: 10px;">
                                <option selected disabled hidden>
                                    Weather Parameters
                                </option>
                                <option>Irradiance</option>
                                <option>Ambient Temperature</option>
                                <option>Module Temperature</option>
                                <option>Wind Speed</option>
                                <option>Wind Direction</option>
                                <option>Humidity</option>
                                <option>Rain</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mT-30">
                    <div id="line-chart" style="display: none;width: 90vw; height: 60vh"></div>
                    <canvas id="scatter-chart" height="100" style="display: block;margin-top: 10px;">
                    </canvas>
                </div>
            </div>
        </div>
        <div class="masonry-item col-md-6">
            <!-- #Monthly Stats ==================== -->
            <div class="bd" style="background-color: #313131;">
                <div class="layers">
                    <div id="sankey" class="layer w-90 h-10">
                    </div>
                </div>
            </div>
        </div>
        <div class="masonry-item col-md-6">
            <div class="bd" style="background-color: #313131;">
                <div class="layers">
                    <div id="heatmap" class="layer w-90 h-10">
                    </div>
                </div>
            </div>
        </div>

    </div>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        var indexofselecteddevice = -1;
        var endpoint = '/api/data/live'
        setInterval(function () {
            $.ajax({
                method: "GET",
                url: endpoint,
                success: function (data) {
                    var Rno = document.getElementById("rno")
                    var Vbat = document.getElementById("vbat");
                    var Vin = document.getElementById("vin");
                    var Spdk = document.getElementById("spdk")
                    latlng(data.data)
                    //let poly = polyline(data.data[i]);
                    //removelayer(marker, poly)
                    {#console.log(data.data);#}
                    {#for (let i = 0; i < data.data.length; i++) {#}
                    {#    Vbat.textContent = data.data[i].VBAT;#}
                    {#    Rno.textContent = data.data[i].RNO;#}
                    {#    Vin.textContent = data.data[i].VIN;#}
                    {#    Spdk.textContent = data.data[i].SPD;#}
                    if (indexofselecteddevice === -1) {
                        Vbat.textContent = 0;
                        Rno.textContent = 0;
                        Vin.textContent = 0;
                        Spdk.textContent = 0;
                    } else {
                        Vbat.textContent = data.data[indexofselecteddevice].VBAT;
                        Rno.textContent = data.data[indexofselecteddevice].RNO;
                        Vin.textContent = data.data[indexofselecteddevice].VIN;
                        Spdk.textContent = data.data[indexofselecteddevice].SPD;
                    }
                }
            })
        }, 1000)

        function latlongconverter(t, g) {
            function lat(t) {
                t = t.slice(1)
                return (Number(t.slice(0, 2)) + (Number(t.slice(2, 9)) / 60))
            }

            function lng(g) {
                g = g.slice(1)
                return (Number(g.slice(0, 3)) + (Number(g.slice(3, 10)) / 60))
            }

            return [lat(t), lng(g)]
        }

        var mymap = L.map('mymapid', {
            center: [19.7515, 75.7139],
            zoom: 6,
            preferCanvas: false,
        });
        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1,
            accessToken: 'pk.eyJ1IjoibWFjaGluZW1hdGgiLCJhIjoiY2toYXFkZmhpMTZubDJybzgwYjkxMWxlbyJ9.UFsD4WU_yE_MVXnTEJbnfA'
        }).addTo(mymap);

        var redIcon = L.icon({
            iconUrl: "/static/assets/static/images/reddot.ico",
            iconSize: [10, 10],
            popupAnchor: [-2, -2],
        });
        var blueIcon = L.icon({
            iconUrl: "/static/assets/static/images/bluedot.ico",
            iconSize: [10, 10],
            popupAnchor: [-2, -2],
        });
        var greenIcon = L.icon({
            iconUrl: "/static/assets/static/images/greendot.ico",
            iconSize: [10, 10],
            popupAnchor: [-2, -2],
        });
        var yellowIcon = L.icon({
            iconUrl: "/static/assets/static/images/yellowdot.ico",
            iconSize: [10, 10],
            popupAnchor: [-2, -2],
        });
        //var marker = L.marker([18.446368,73.816035],{icon:myIcon}).addTo(mymap);
        const colors = [redIcon, blueIcon, yellowIcon, greenIcon]
        var bll = []

        function latlng(data) {
            var ll = []
            for (let i = 0; i < data.length; i++) {
                if (data[i].LAT !== "" && data[i].LNG !== "") {
                    if (data[i].LAT[0] === '+' && data[i].LNG[0] === '+') {
                        ll = latlongconverter(data[i].LAT, data[i].LNG)
                    } else {
                        let latitude = parseFloat(data[i].LAT)
                        let longitude = parseFloat(data[i].LNG)
                        ll = [latitude, longitude]
                    }
                    bll.push(ll)

                    {#console.log([latitude, longitude]);#}
                    {#console.log(colors);#}
                    let marker = L.marker(ll, {icon: colors[i % 4]}).addTo(mymap);
                    removelayer(marker);
                }
            }
            //marker.bindPopup(data1.lat+","+data1.lng).openPopup();
            {#return marker#}
        }

        setTimeout(function () {
            mymap.flyToBounds(bll)
        }, 5000)

        async function removelayer(marker) {
            await sleep(5000)
            mymap.removeLayer(marker)
            // mymap.removeLayer(poly)
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@0.1.3/dist/chartjs-chart-matrix.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/1.58.4/plotly.min.js" integrity="sha512-odxyOOOwpEgYQnS+TzF/P33O+DfGNGqyh89pJ/u2addhMw9ZIef3M8aw/otYSgsPxLdZi3HQhlI9IiX3H5SxpA==" crossorigin="anonymous"></script>
    <script>
        var xValues = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23'];

        var yValues = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31'];

        var zValues = [
            [0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 5, 0, 1, 2, 3],
            [0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3],
            [0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 8, 10, 12, 2, 3],
            [0, 1, 2, 3, 4, 0, 1, 6, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3],
            [0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3],
            [0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3],
            [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23],
            [0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 5, 0, 1, 2, 3],
            [0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3],
            [0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 8, 10, 12, 2, 3],
            [0, 1, 2, 3, 4, 0, 1, 6, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3],
            [0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3],
            [0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3],
            [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23],
            [0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 5, 0, 1, 2, 3],
            [0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3],
            [0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 8, 10, 12, 2, 3],
            [0, 1, 2, 3, 4, 0, 1, 6, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3],
            [0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3],
            [0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3],
            [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23],
            [0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 5, 0, 1, 2, 3],
            [0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3],
            [0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 8, 10, 12, 2, 3],
            [0, 1, 2, 3, 4, 0, 1, 6, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3],
            [0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3],
            [0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3],
            [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23],
            [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23],
            [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23],
            [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23]

        ];

        var colorscaleValue = [
            [0, '#ffffff'],
            [0.1, '#e6ffe6'],
            [0.2, '#b3ffb3'],
            [0.3, '#80ff80'],
            [0.4, '#66ff66'],
            [0.5, '#33ff33'],
            [0.6, '#00ff00'],
            [0.7, '#00cc00'],
            [0.8, '#009900'],
            [0.9, '#006600'],
            [1, '#003300'],


        ];

        var data = [{
            x: xValues,
            y: yValues,
            z: zValues,
            type: 'heatmap',
            colorscale: colorscaleValue,
            showscale: false,
            xgap: 3,
            ygap: 3
        }];

        var layout = {
            paper_bgcolor: '#313131',
            plot_bgcolor: 'rgba(0,0,0,0)',
            title: 'Heatmap',
            width: 590,
            height: 500,
            titlefont: {
                family: 'Old Standard TT, serif',
                size: 14,
                color: 'white'
            },
            annotations: [],
            xaxis: {
                ticks: '',
                side: 'bottom',
                tickfont: {
                    family: 'Old Standard TT, serif',
                    size: 14,
                    color: 'white'
                },
            },
            yaxis: {
                ticks: '',
                ticksuffix: ' ',
                autosize: false,
                showgrid: true,
                tickfont: {
                    family: 'Old Standard TT, serif',
                    size: 14,
                    color: 'white'
                },
            },

        };

        for (var i = 0; i < yValues.length; i++) {
            for (var j = 0; j < xValues.length; j++) {
                var currentValue = zValues[i][j];

                var result = {
                    xref: 'x1',
                    yref: 'y1',
                    x: xValues[j],
                    y: yValues[i],
                    text: zValues[i][j],
                    font: {
                        family: 'Arial',
                        size: 12,
                        color: 'rgb(50, 171, 96)',
                        color: 'white'
                    },
                    showarrow: false
                };
                //  layout.annotations.push(result);
            }
        }

        Plotly.newPlot('heatmap', data, layout);
    </script>
    <script>
        var data2 = {
            "type": "sankey",
            "domain": {
                "x": [
                    0,
                    1
                ],
                "y": [
                    0,
                    1
                ]
            },
            "orientation": "h",
            "valueformat": ".0f",
            "valuesuffix": "TWh",
            "node": {
                "pad": 15,
                "thickness": 15,
                "line": {
                    "color": "black",
                    "width": 0.5
                },
                "label": [
                    "Agricultural 'waste'",
                    "Bio-conversion",
                    "Liquid",
                    "Losses",
                    "Solid",
                    "Gas",
                    "Biofuel imports",
                    "Biomass imports",
                    "Coal imports",
                    "Coal",
                    "Coal reserves",
                    "District heating",
                    "Industry",
                    "Heating and cooling - commercial",
                    "Heating and cooling - homes",
                    "Electricity grid",
                    "Over generation / exports",
                    "H2 conversion",
                    "Road transport",
                    "Agriculture",
                    "Rail transport",
                    "Lighting & appliances - commercial",
                    "Lighting & appliances - homes",
                    "Gas imports",
                    "Ngas",
                    "Gas reserves",
                    "Thermal generation",
                    "Geothermal",
                    "H2",
                    "Hydro",
                    "International shipping",
                    "Domestic aviation",
                    "International aviation",
                    "National navigation",
                    "Marine algae",
                    "Nuclear",
                    "Oil imports",
                    "Oil",
                    "Oil reserves",
                    "Other waste",
                    "Pumped heat",
                    "Solar PV",
                    "Solar Thermal",
                    "Solar",
                    "Tidal",
                    "UK land based bioenergy",
                    "Wave",
                    "Wind"
                ],
                "color": [
                    "rgba(31, 119, 180, 0.8)",
                    "rgba(255, 127, 14, 0.8)",
                    "rgba(44, 160, 44, 0.8)",
                    "rgba(214, 39, 40, 0.8)",
                    "rgba(148, 103, 189, 0.8)",
                    "rgba(140, 86, 75, 0.8)",
                    "rgba(227, 119, 194, 0.8)",
                    "rgba(127, 127, 127, 0.8)",
                    "rgba(188, 189, 34, 0.8)",
                    "rgba(23, 190, 207, 0.8)",
                    "rgba(31, 119, 180, 0.8)",
                    "rgba(255, 127, 14, 0.8)",
                    "rgba(44, 160, 44, 0.8)",
                    "rgba(214, 39, 40, 0.8)",
                    "rgba(148, 103, 189, 0.8)",
                    "rgba(140, 86, 75, 0.8)",
                    "rgba(227, 119, 194, 0.8)",
                    "rgba(127, 127, 127, 0.8)",
                    "rgba(188, 189, 34, 0.8)",
                    "rgba(23, 190, 207, 0.8)",
                    "rgba(31, 119, 180, 0.8)",
                    "rgba(255, 127, 14, 0.8)",
                    "rgba(44, 160, 44, 0.8)",
                    "rgba(214, 39, 40, 0.8)",
                    "rgba(148, 103, 189, 0.8)",
                    "rgba(140, 86, 75, 0.8)",
                    "rgba(227, 119, 194, 0.8)",
                    "rgba(127, 127, 127, 0.8)",
                    "rgba(188, 189, 34, 0.8)",
                    "rgba(23, 190, 207, 0.8)",
                    "rgba(31, 119, 180, 0.8)",
                    "rgba(255, 127, 14, 0.8)",
                    "rgba(44, 160, 44, 0.8)",
                    "rgba(214, 39, 40, 0.8)",
                    "rgba(148, 103, 189, 0.8)",
                    "magenta",
                    "rgba(227, 119, 194, 0.8)",
                    "rgba(127, 127, 127, 0.8)",
                    "rgba(188, 189, 34, 0.8)",
                    "rgba(23, 190, 207, 0.8)",
                    "rgba(31, 119, 180, 0.8)",
                    "rgba(255, 127, 14, 0.8)",
                    "rgba(44, 160, 44, 0.8)",
                    "rgba(214, 39, 40, 0.8)",
                    "rgba(148, 103, 189, 0.8)",
                    "rgba(140, 86, 75, 0.8)",
                    "rgba(227, 119, 194, 0.8)",
                    "rgba(127, 127, 127, 0.8)"]
            },
            "link": {
                "source": [
                    8,
                    10,
                    9,
                    15,
                    15,
                    15,
                    15,
                    15,
                    15,
                    15,
                    15,
                    15,
                    15,
                    15,
                    23,
                    25,
                    5,
                    5,
                    5,
                    5,
                    5,
                    27,
                    28,
                    29,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    2,
                    24,
                    35,
                    35,
                    36,
                    38,
                    37,
                    40,
                    40,
                    41,
                    42,
                    43,
                    43,
                    4,
                    4,
                    4,
                    26,
                    26,
                    26,
                    47,
                    35,
                    35
                ],
                "target": [
                    9,
                    9,
                    4,
                    16,
                    14,
                    17,
                    12,
                    18,
                    19,
                    13,
                    3,
                    20,
                    21,
                    22,
                    24,
                    24,
                    13,
                    3,
                    26,
                    19,
                    12,
                    15,
                    18,
                    15,
                    12,
                    30,
                    18,
                    31,
                    32,
                    19,
                    33,
                    20,
                    5,
                    26,
                    26,
                    37,
                    37,
                    2,
                    14,
                    13,
                    15,
                    14,
                    42,
                    41,
                    19,
                    26,
                    12,
                    15,
                    3,
                    11,
                    15,
                    26,
                    26
                ],
                "value": [
                    11.606,
                    63.965,
                    75.571,
                    104.453,
                    113.726,
                    27.14,
                    342.165,
                    37.797,
                    4.412,
                    40.858,
                    56.691,
                    7.863,
                    90.008,
                    93.494,
                    40.719,
                    82.233,
                    0.129,
                    1.401,
                    151.891,
                    2.096,
                    48.58,
                    7.013,
                    20.897,
                    6.995,
                    121.066,
                    128.69,
                    135.835,
                    14.458,
                    206.267,
                    3.64,
                    33.218,
                    4.413,
                    122.952,
                    500,
                    139.978,
                    504.287,
                    107.703,
                    611.99,
                    193.026,
                    70.672,
                    59.901,
                    19.263,
                    19.263,
                    59.901,
                    0.882,
                    400.12,
                    46.477,
                    525.531,
                    787.129,
                    79.329,
                    289.366,
                    100,
                    100
                ],
                "color": [
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(33,102,172,0.35)",
                    "rgba(178,24,43,0.35)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "rgba(0,0,96,0.2)",
                    "lightgreen",
                    "goldenrod"
                ],
                "label": [
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "stream 1",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "Old generation plant (made-up)",
                    "New generation plant (made-up)",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    "",
                    ""
                ]
            }
        }
        var data = [data2]
        var layout2 = {
            "title": {"text": "Sankey Chart"},
            "width": 590,
            "height": 500,
            "font": {
                "size": 10,
            },
            titlefont: {
                family: 'Old Standard TT, serif',
                size: 14,
                color: 'white'
            },
        }
        Plotly.newPlot('sankey', data, layout2)
    </script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"
            integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ=="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.1.2/js/tempusdominus-bootstrap-4.min.js"
            integrity="sha512-2JBCbWoMJPH+Uj7Wq5OLub8E5edWHlTM4ar/YJkZh3plwB2INhhOC3eDoqHm1Za/ZOSksrLlURLoyXVdfQXqwg=="
            crossorigin="anonymous"></script>
    <script src="/static/assets/jQuery-Multiple-Select-Plugin-For-Bootstrap-Bootstrap-Multiselect/dist/js/bootstrap-multiselect.min.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            $('#myFilter').multiselect({
                buttonWidth: '100%'
            });
            $('#myFilter2').multiselect({
                buttonWidth: '100%'
            });
        });
    </script>
    <script>
        $(function () {
            $('#myFilter2').multiselect();
        });
    </script>
    <script type="text/javascript">
        $(function () {
            $('#datetimepicker1').datetimepicker({
                format: 'YYYY-MM-DD HH:mm:ss',
            });
        });
        $(function () {
            $('#datetimepicker2').datetimepicker({
                format: 'YYYY-MM-DD HH:mm:ss',
            });
        });
    </script>
    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');
    </script>
    {#    <script>#}
    {#        start()#}
    {#    </script>#}
    <script src="https://cdn.jsdelivr.net/npm/moment@2.24.0/min/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@1.8.0"></script>

    <script>
        var oldrno = -1;
        var clr = 0
        var VIN, VBAT, TIME, TP, APPD, CELV, ES, ECT, SPD,V3,V3_CONV

        function livedata() {
            $.ajax({
                method: "GET",
                url: 'api/data/live',
                success: function (data) {
                    if (indexofselecteddevice !== -1) {
                        if (data.data[indexofselecteddevice].RNO !== oldrno) {
                            //  addData(data.data[1]);
                            {#addData1(data.data[1]);#}
                            VIN = data.data[indexofselecteddevice].VIN
                            VBAT = data.data[indexofselecteddevice].VBAT
                            SPD = data.data[indexofselecteddevice].SPD
                            V3 = data.data[indexofselecteddevice].V3
                            V3_CONV = data.data[indexofselecteddevice].V3_CONV
                            TIME = data.data[indexofselecteddevice].EDT
                            oldrno = data.data[indexofselecteddevice].RNO;
                        }
                    }
                    //if (chart.data.labels.length >= 30) {
                    //removedata();
                    {#removedata1()#}
                    //}
                },
                error: function (error_data) {
                    console.log("error")
                    console.log(error_data)
                }
            })
        }

        setInterval(livedata, 500)
        var chartColors = {
            red: 'rgb(255, 99, 132)',
            orange: 'rgb(255, 159, 64)',
            yellow: 'rgb(255, 205, 86)',
            green: 'rgb(75, 192, 192)',
            blue: 'rgb(54, 162, 235)',
            purple: 'rgb(153, 102, 255)',
            grey: 'rgb(201, 203, 207)'
        };

        function randomScalingFactor() {
            return (Math.random() > 0.5 ? 1.0 : -1.0) * Math.round(Math.random() * 100);
        }


        function datavar() {
            return [VIN, VBAT, V3,V3_CONV,SPD, TP, APPD, CELV, ES, ECT]
        }

        function onRefresh(chart) {
            let lab = ["VIN", "VBAT", "V3",'V3_CONV',"SPD", "TP", "APPD", "CELV", "ES", "ECT"]
            let i = 0
            let dat = datavar()
            {#console.log(dat)#}
            chart.config.data.datasets.forEach(function (dataset) {
                dataset.data.push({
                    x: TIME,
                    y: dat[lab.indexOf(dataset.label)]
                })
            })
        }

        var color = Chart.helpers.color;
        var ctx = document.getElementById('scatter-chart').getContext('2d');
        var config = {
            type: 'line',
            data: {
                datasets: []
            },
            options: {
                legend: {
                    display: true,
                    align: 'center',
                    labels: {
                        usePointStyle: true,
                        boxWidth: 10,
                        fontColor: '#fff',
                        lineCap: 'butt',
                    }
                },
                elements: {
                    point: {
                        radius: 1
                    }
                },
                scales: {
                    xAxes: [{
                        type: 'realtime',
                        realtime: {
                            duration: 300000,
                            //20000
                            refresh: 2000,
                            //1000
                            delay: 0,
                            //7000
                            onRefresh: onRefresh
                        },
                        gridLines: {color: "#696969"},
                        ticks: {
                            fontColor: "white",
                        }
                    }],
                    yAxes: []
                },
                tooltips: {
                    mode: 'nearest',
                    intersect: false
                },
                hover: {
                    mode: 'nearest',
                    intersect: false
                }
            }
        };
        var chart1 = new Chart(ctx, config)
        let lab = ["VIN", "VBAT", "V3",'V3_CONV',"SPD", "TP", "APPD", "CELV", "ES", "ECT"]
        let unit = ["Volt", "Volt", "Volt","mAmp","Kmph", "", "", "", "", ""]
        var colorNames = Object.keys(chartColors);

        function addDatasets1(index) {
            var colorName = colorNames[config.data.datasets.length % colorNames.length];
            var newColor = chartColors[colorName];
            var newDataset = {
                label: lab[index],
                backgroundColor: color(newColor).alpha(0.5).rgbString(),
                borderColor: newColor,
                fill: false,
                data: [],
                yAxisID: 'y-axis-' + index,
                pointStyle: "line",
                borderWidth: 1.5,
            };

            config.data.datasets.push(newDataset);
            addScale(index)
            console.log('y-axis-' + index)
            chart1.update();
        };

        function addScale(index) {

            var newScale = {
                id: 'y-axis-' + index,
                scaleLabel: {
                    display: true,
                    labelString: lab[index] + " (" + unit[index] + ")"
                },
                gridLines: {color: "#696969"},
                ticks: {
                    fontColor: "white"
                }
            }
            if (index % 2 === 0) {
                newScale.position = "left"
            } else {
                newScale.position = "right"
            }
            console.log(index)
            config.options.scales.yAxes.push(newScale)
            chart1.update()
        }

        function removeDatasets(index) {
            let lab = ["VIN", "VBAT", "V3",'V3_CONV',"SPD", "TP", "APPD", "CELV", "ES", "ECT"]
            chart1.config.data.datasets.forEach(function (dataset) {
                console.log(index)
                if (dataset.label === lab[index]) {
                    config.data.datasets.pop();
                    config.options.scales.yAxes.pop()
                    chart1.update();
                }
            })

        };

        function addds(selectedarray) {
            let lab = ["VIN", "VBAT", "V3","V3_CONV","SPD", "TP", "APPD", "CELV", "ES", "ECT" ]
            for (var i = 0; i < selectedarray.length; i++) {
                var flag = 0
                lab.indexOf(selectedarray[i])
                console.log(chart1.config.data.datasets.length)
                for (var j = 0; j < chart1.data.datasets.length; j++) {
                    if (chart1.data.datasets[j].label === selectedarray[i]) {
                        flag = 1
                        break
                    } else if (chart1.data.datasets[j].label !== selectedarray[i]) {
                        flag = 0
                    }
                }
                if (flag === 0) {
                    addDatasets1(lab.indexOf(selectedarray[i]))
                }
            }
            for (var k = 0; k < chart1.config.data.datasets.length; k++) {
                var flag = 0
                lab.indexOf(selectedarray[k])
                console.log(chart1.config.data.datasets.length)
                for (var l = 0; l < selectedarray.length; l++) {
                    if (chart1.data.datasets[k].label === selectedarray[l]) {
                        flag = 1
                        break
                    } else if (chart1.data.datasets[k].label !== selectedarray[l]) {
                        flag = 0
                    }
                }
                if (flag === 0) {
                    removeDatasets(lab.indexOf(chart1.config.data.datasets[k].label))
                }
            }
        }

    </script>
    <script>
        $(function () {
            $('#myFilter').multiselect();
        });

        function assign_params(selecteddevice) {
            $.ajax({
                method: "GET",
                url: 'api/data/userinfo',
                success: function (data) {
                    console.log(data)
                    indexofselecteddevice = data.all_devices.indexOf(selecteddevice)
                    var data2 = [];
                    for (let i = 0; i < data.all_devices.length; i++) {
                        if (data.all_devices[i] === selecteddevice) {
                            console.log(data.all_devices[i])
                            for (let j = 0; j < data.chartprefrence[i].length; j++) {
                                data2.push({label: data.chartprefrence[i][j], value: data.chartprefrence[i][j]})
                            }
                            $('#myFilter').multiselect('dataprovider', data2);
                        }
                    }
                    {#$('#myFilter').multiselect('reload')#}

                }
            })
        }

        var deviceselected = "";
        $('#selectdevice').change(function () {
            console.log($(this).val());
            deviceselected = $(this).val()
            {#$('#myFilter').empty()#}
            assign_params($(this).val())
        })


    </script>
    <script>
        var selected = []
        $("#myFilter").on('change', function () {
            selected = $("#myFilter").val();
            console.log(selected)
            addds(selected)
        })
    </script>
    <script>
        function get_archive_data() {
            console.log($("#fromdata").val() + " " + $("#todata").val())
            $.ajax({
                method: "POST",
                url: "api/data/archive",
                async: true,
                data: {
                    'csrfmiddlewaretoken': csrftoken,
                    'from': $("#fromdata").val(),
                    'to': $("#todata").val(),
                    'parameters[]': selected,
                    'device': deviceselected
                },
                success: function (result, status, xhr) {
                    //clearInterval(clr)
                    //archive = true
                    var x = document.getElementById("scatter-chart");
                    var y = document.getElementById("line-chart");
                    console.log(result)
                    // search(result)
                    adjustValue1(result)
                    if (x.style.display === "block") {
                        x.style.display = "none"
                        y.style.display = "block"
                    } else {
                        y.style.display = "block"
                    }
                },
                error: function (error_data) {
                    console.log("error")
                    alert("error")
                    console.log(error_data)
                }
            })
        }

        function refreshdata() {
            archive = false
            var x = document.getElementById("scatter-chart");
            var y = document.getElementById("line-chart");
            if (x.style.display === "none") {
                x.style.display = "block"
                y.style.display = "none"
            } else {
                x.style.display = "block"
            }
        }

        {##}
        {#var data = [#}
        {#    {#}
        {#        x: ['2013-10-04 22:23:00', '2013-11-04 22:23:00', '2013-12-04 22:23:00'],#}
        {#        y: [1, 3, 6],#}
        {#        type: 'scatter'#}
        {#    }#}
        {#];#}
        {#var config1 = {responsive: true}#}
        {#Plotly.newPlot('line-chart', data, config1);#}
        var col = ['rgb(255, 99, 132)', 'rgb(255, 159, 64)', 'rgb(255, 205, 86)', 'rgb(75, 192, 192)', 'rgb(54, 162, 235)', 'rgb(153, 102, 255)', 'rgb(201, 203, 207)']

        function adjustValue1(value) {
            var trace = {}
            var tracedata = []
            for (let i = 0; i < value.param.length; i++) {
                trace.name = value.param[i]
                trace.x = value.labels
                trace.y = value.selected[i]
                trace.type = 'line'
                trace.marker = {
                    color: col[i],
                    size: 5
                }
                if (i !== 0) {
                    trace.yaxis = `y${i + 1}`
                }
                tracedata.push(trace)
                trace = {}
            }
            console.log(tracedata)
            {#var newd =#}
            {#    {#}
            {#        name: "Vin",#}
            {#        x: value.labels,#}
            {#        y: value.selected[0],#}
            {#        type: 'line',#}
            {#        marker: {#}
            {#            color: "rgb(255,103,0)",#}
            {#            size: 5#}
            {#        },#}
            {##}
            {#    }#}
            {#var newd2 =#}
            {#    {#}
            {#        name: "Vbat",#}
            {#        x: value.labels,#}
            {#        y: value.selected[1],#}
            {#        type: 'line',#}
            {#        yaxis: 'y2',#}
            {#        marker: {#}
            {#            color: "rgb(57,255,20)",#}
            {#            size: 5#}
            {#        },#}
            {#    }#}
            {#var newd3 =#}
            {#    {#}
            {#        name: "SPDK",#}
            {#        x: value.labels,#}
            {#        y: value.selected[2],#}
            {#        type: 'line',#}
            {#        yaxis: 'y3',#}
            {#        marker: {#}
            {#            color: "#8B78E6",#}
            {#            size: 5#}
            {#        },#}
            {#    }#}
            {#var tracedata = [newd, newd2, newd3];#}
            var layout = {
                legend: {
                    x: 0.5,
                    y: 1.3,
                    "orientation": "h",
                    font: {
                        family: 'sans-serif',
                        size: 12,
                        color: '#fff'
                    },
                },
                margin: {
                    l: 50,
                    r: 50,
                    b: 25,
                    t: 25,
                },
                autosize: true,
                paper_bgcolor: '#313131',
                plot_bgcolor: 'rgba(0,0,0,0)',
                xaxis: {
                    ticks: '',
                    side: 'bottom',
                    gridcolor: '#696969',
                    linecolor: '#696969',
                    tickfont: {
                        family: 'Old Standard TT, serif',
                        size: 14,
                        color: 'white'
                    },
                    domain: [0.1, 1]
                },
                yaxis: {
                    title: value.param[0],
                    gridcolor: '#696969',
                    linecolor: '#696969',
                    titlefont: {color: col[0]},
                    tickfont: {
                        family: 'Old Standard TT, serif',
                        size: 14,
                        color: 'white'
                    },
                    anchor: 'x',
                },
                yaxis2: {
                    title: value.param[1],
                    gridcolor: '#696969',
                    linecolor: '#696969',
                    titlefont: {color: col[1]},
                    overlaying: 'y',
                    side: 'right',
                    tickfont: {
                        family: 'Old Standard TT, serif',
                        size: 14,
                        color: 'white'
                    },
                    anchor: 'x',
                },
                yaxis3: {
                    title: value.param[2],
                    gridcolor: '#696969',
                    linecolor: '#696969',
                    titlefont: {color: col[2]},
                    overlaying: 'y',
                    side: 'left',
                    tickfont: {
                        family: 'Old Standard TT, serif',
                        size: 14,
                        color: 'white'
                    },
                    anchor: 'free',
                    position: 0.05,
                },
                {#yaxis4: {#}
                {#    title: value.param[3],#}
                {#    gridcolor: '#696969',#}
                {#    linecolor: '#696969',#}
                {#    titlefont: {color: col[3]},#}
                {#    overlaying: 'y',#}
                {#    side: 'right',#}
                {#    tickfont: {#}
                {#        family: 'Old Standard TT, serif',#}
                {#        size: 14,#}
                {#        color: 'white'#}
                {#    },#}
                {#    anchor: 'free',#}
                {#    position:1},#}
            };
            Plotly.newPlot('line-chart', tracedata, layout, {modeBarButtonsToRemove: ['hoverClosestCartesian', 'zoom2d', 'hoverCompareCartesian', 'zoomIn2d', 'zoomOut2d', 'pan2d', 'toggleSpikelines', 'resetScale2d']});
        }
    </script>
    {#    Weather Api Integration#}
    <script>
        function getWeatherData() {
            $.ajax({
                method: "GET",
                url: 'https://api.openweathermap.org/data/2.5/onecall?lat=18.5204&lon=73.8567&units=metric&appid=1584befebac7a5dea1b3a2df0ad418c9',
                success: function (data) {
                    console.log(data)
                    let d = new Date(data.current.dt * 1000);
                    let sr = new Date(data.current.sunrise * 1000)
                    let ss = new Date(data.current.sunset * 1000)
                    let ws = data.current.wind_speed * 1.609344
                    let x = ss.getHours() - 12
                    let months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Des"]
                    let days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]
                    document.getElementById("todaysday").innerHTML = days[d.getDay()];
                    document.getElementById("todaysdate").innerHTML = months[d.getMonth()] + ", " + d.getDate() + " " + d.getFullYear()
                    document.getElementById("todaytemp").innerHTML = data.current.temp + '<sup>℃</sup>'
                    document.getElementById("todayssunrise").innerHTML = "0" + sr.getHours() + ":" + sr.getMinutes() + " " + "AM"
                    document.getElementById("todayssunset").innerHTML = "0" + x.toString() + ":" + ss.getMinutes() + " " + "PM"
                    document.getElementById("todayswindspeed").innerHTML = data.current.wind_speed + " m/s"
                    document.getElementById("todayswinddir").innerHTML = data.current.wind_deg + "°"
                    document.getElementById("todayshumdity").innerHTML = data.current.humidity + "%"
                    console.log(d)
                    document.getElementById("todayweatherdesc").innerHTML = data.current.weather[0].description;
                    document.getElementById("todayweather").className = "wi wi-owm-" + data.current.weather[0].id;
                    let weekelements = [document.getElementById("sutemp"), document.getElementById("mtemp"), document.getElementById("tutemp"), document.getElementById("wtemp"), document.getElementById("thtemp"), document.getElementById("ftemp"), document.getElementById("satemp")]
                    let weatherid = [document.getElementById("sunweather"), document.getElementById("monweather"), document.getElementById("tueweather"), document.getElementById("wedweather"), document.getElementById("thrweather"), document.getElementById("friweather"), document.getElementById("satweather")]
                    for (let i = 0; i < data.daily.length - 1; i++) {
                        let dat = new Date(data.daily[i].dt * 1000)
                        weekelements[dat.getDay()].innerHTML = data.daily[i].temp.max + '<sup>℃</sup>'
                        weatherid[dat.getDay()].className = "wi wi-owm-" + data.daily[i].weather[0].id
                    }
                },
                error: function (error_data) {
                    console.log("error")
                    console.log(error_data)
                }
            })
        }

        setInterval(getWeatherData(), 60000)

    </script>

{% endblock javascripts %}
